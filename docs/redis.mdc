---
title: Redis Storage Setup
---

# Redis Storage Setup

This project uses Redis for persistent game state storage in the MMORPG.

## Configuration

Redis connection is configured via environment variables. Create a `.env.local` file (or set environment variables in your deployment):

### Option 1: Redis URL (Recommended)
```bash
REDIS_URL=redis://localhost:6379
```

### Option 2: Individual Parameters
```bash
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_USERNAME=default  # Optional, required for Redis Cloud and some providers
REDIS_PASSWORD=         # Optional, required for Redis Cloud and password-protected instances
```

**Note:** All Redis connections use TLS by default. The client automatically enables TLS for all connections.

### Example: Redis Cloud Configuration
```bash
REDIS_HOST=redis-12901.c328.europe-west3-1.gce.redns.redis-cloud.com
REDIS_PORT=12901
REDIS_USERNAME=default
REDIS_PASSWORD=your-password-here
```

**Note:** TLS is automatically enabled for all connections. When using `REDIS_URL`, `redis://` URLs are automatically converted to `rediss://` (TLS).

## Redis Providers

For production, consider these managed Redis services:

- **Upstash**: https://upstash.com (serverless Redis, free tier available)
- **Railway**: https://railway.app (managed Redis)
- **Redis Cloud**: https://redis.com/cloud (Redis Enterprise)

## Local Development

### Using Docker
```bash
docker run -d -p 6379:6379 redis:latest
```

### Using Homebrew (macOS)
```bash
brew install redis
brew services start redis
```

## RPC API

Game state operations use RPC (Remote Procedure Calls) via Protocol Buffers. See [RPC documentation](./rpc.mdc) for details on the proto-based API architecture.

### World Service

The primary service for managing worlds:

```typescript
import { createWorld, getWorld } from "@/src/lib/rpc/worldClient";

// Create a world (includes player, beji, and static bejis)
const response = await createWorld("My Beji", [0x1f600]);
const { world, player, beji, staticBeji } = response.world;

// Get a world
const worldData = await getWorld(worldId);
```

**RPC Endpoint**: `POST /api/rpc/world/v1` with `method: "CreateWorld"` or `method: "GetWorld"`

## Data Structure in Redis

Redis stores game data using the following key patterns:

- `beji:gameState` - Full game state (JSON)
- `beji:players` - Set of player IDs
- `beji:player:{playerId}` - Player data (JSON)
- `beji:beji` - Set of beji IDs
- `beji:beji:{bejiId}` - Beji data (JSON)
- `beji:player:{playerId}:beji` - Set of beji IDs for a player
- `beji:worlds` - Set of world IDs
- `beji:world:{worldId}` - World data (JSON)
- `beji:world:{worldId}:staticBeji` - Set of static beji IDs in a world
- `beji:world:{worldId}:beji` - Set of beji IDs in a world
- `beji:staticBeji` - Set of static beji IDs
- `beji:staticBeji:{staticBejiId}` - Static beji data (JSON)
- `beji:inventory:{playerId}` - Inventory data (JSON)

### World Data Structure

A **World** in Redis is represented by multiple keys:

1. **Main World Record** (`beji:world:{worldId}`): JSON string containing:
   ```json
   {
     "id": "world-1234567890",
     "mainBejiId": "beji-1234567890",
     "staticBejiIds": ["static-beji-1", "static-beji-2", ...],
     "createdAt": 1234567890123
   }
   ```

2. **World IDs Set** (`beji:worlds`): Redis SET containing all world IDs

3. **World Static Beji Index** (`beji:world:{worldId}:staticBeji`): Redis SET of static beji IDs in this world

4. **World Beji Index** (`beji:world:{worldId}:beji`): Redis SET of beji IDs in this world

This normalized structure allows:
- Quick lookup of which static bejis belong to a world
- Efficient queries for all entities in a world
- Maintains referential integrity through sets
- Single source of truth for world configuration

## Server-Side Usage

Server-side Redis operations are available via `src/lib/redis/gameState.ts`:

```typescript
import {
    getGameState,
    saveGameState,
    getPlayer,
    savePlayer,
    getAllPlayers,
    saveWorld,
    getWorld,
    saveBeji,
    getBeji,
    saveStaticBeji,
    getStaticBejiForWorld,
    getInventory,
    saveInventory,
    // ... etc
} from "@/src/lib/redis/gameState";
```

These functions are used by the RPC routes and can be imported in server components or API routes. The Redis connection is automatically managed via `getRedisClient()`.
