---
alwaysApply: true
title: Testing
---

# Testing

## Framework
- Use Vitest for unit tests and component tests.
- Mock global features for coverage and isolation.

## Setup
- ✅ `vitest` v4 is installed and configured via `vitest.config.ts`
- ✅ Basic `test` script in `package.json` (`pnpm test`)
- ✅ Coverage configured with `@vitest/coverage-v8` provider
- ✅ `dotenv` package installed for loading `.env.local` in tests
- ✅ `jsdom` installed for DOM testing (canvas, ResizeObserver, etc.)
- ✅ Default test environment is `node`; component tests use `@vitest-environment jsdom` directive at the top of test files to override
- ✅ Redis integration tests load `.env.local` directly at the top of test files (to avoid interfering with unit tests)
- ✅ Use `@testing-library/react` and `jsdom` for component testing

## Vitest 4 Migration
- All tests migrated to Vitest 4
- Mock constructors use function syntax (not arrow functions) per Vitest 4 requirements
- Constructor mocking pattern: `vi.fn(ConstructorFunction)` instead of `.mockImplementation(() => instance)`

## Guidelines
- Test public surface of components (props → UI behavior).
- Mock network/realtime boundaries; don't hit real routers in unit tests.
- Keep tests fast; avoid global state bleed.

## Scope

Check all the components and make sure they have associated tests.
Each react component needs to have SSR rendering tests to ensure they render correctly on the server and clients.

## Running Coverage

Run test coverage reports with:
- `pnpm test:coverage` - Generate coverage report and exit
- `pnpm test:coverage:ui` - Interactive coverage UI with watch mode

Coverage reports are generated in:
- Terminal output (text)
- `coverage/` directory (HTML, LCOV, JSON)

Configuration in `vitest.config.ts`:
- Provider: V8
- Includes: app, components, hooks, lib, src directories
- Excludes: node_modules, tests, config files, proto files

## Test Coverage

### Unit Tests
- ✅ `tests/static-beji.test.ts` - Static beji creation, harvesting logic, inventory system, and map bounds
- ✅ `tests/redis-client.test.ts` - Redis client configuration using `node-redis` (official Redis client), connection (including username, password, TLS), and singleton pattern
- ✅ `tests/redis-gameState.test.ts` - Redis game state operations (players, beji, static beji, inventory, worlds) using `node-redis` API
- ✅ `tests/world-rpc.test.ts` - World RPC API (CreateWorld and GetWorld) with mocked Redis
- ✅ `tests/debugOverlay.test.ts` - Debug overlay drawing function with edge cases (undefined positions, targets, physics positions)
- ✅ `tests/auth-jwt.test.ts` - JWT authentication functions (signJWT, verifyJWT) with validation, tampering, and edge case tests
- ✅ `tests/auth-oauth.test.ts` - Google OAuth authentication flow (OAuth callback route, get-token route) with error handling, token exchange, user info fetching, cookie management, and all edge cases
- ✅ `tests/utilities.test.ts` - Utility functions (touchUtils: getTouchDistance, getTouchCenter; emoji: codepointsToEmoji) with edge cases
- ✅ `tests/drawing-functions.test.ts` - Canvas drawing functions (background, grid, originMarker, guidanceLine, staticBeji, beji, canvasSetup) with edge cases
- ✅ `tests/useKeyboardMovement.test.tsx` - Keyboard movement hook with all arrow keys, custom step sizes, disabled state, and cleanup

### Component Tests
- ✅ `tests/canvas-map.test.tsx` - CanvasMap component initialization order tests. Specifically catches "Cannot access X before initialization" errors when refs are accessed in hooks before declaration. Uses SSR rendering to surface initialization issues early.

### Component SSR Tests  
- ✅ `tests/map-ssr.test.tsx` - Map component SSR
- ✅ `tests/emoji-ssr.test.tsx` - Emoji page SSR
- ✅ `tests/locale-ssr.test.ts` - Home page SSR with language support (language managed via jotai state/localStorage, not URL routing)
- ✅ `tests/components-ssr.test.tsx` - Component SSR rendering for all components: Map, MapGrid, StartPage, LocaleSwitcher, Tooltip, VirtualJoystick, Header, EmojiPicker, BejiNameInput, SelectedPreview, StartAction, CreateBejiForm, BejisLoader, InventoryDisplay, ToggleFollowMouseAction, ZoomToBejiAction, ActionsBar, JotaiProvider, CanvasMap, LanguageProvider, UserMenu, ExistingBejisList
- ✅ `tests/page-import.test.ts` - Regression test to ensure `app/page.tsx` imports without throwing (catches invalid require usage)

### Integration Tests  
- ✅ `tests/dev-server.test.ts` - Dev server startup
- ✅ `tests/dev-server-3001.test.ts` - Dev server startup on port 3001 (runs only when `INTEGRATION=1` env var is set)
- ✅ `tests/redis-integration.test.ts` - Redis connection verification and basic operations (hashes, lists) using `node-redis` and `.env.local` credentials. Tests are skipped gracefully if Redis is unavailable.
- ✅ `tests/redis-beji-world.test.ts` - Redis integration tests for creating beji and worlds using same methods as app (`savePlayer`, `saveBeji`, `saveWorld`, `saveStaticBeji`). Tests the complete CreateWorld flow with real Redis storage. Tests are skipped gracefully if Redis is unavailable.
- ✅ `tests/user-registration.test.ts` - Redis integration tests for user registration, player creation, and linking users to players. Tests `linkUserToPlayer`, `getOrCreatePlayerForUser`, and related operations using real Redis storage. Tests are skipped gracefully if Redis is unavailable.
- ✅ `tests/redis-cloud.test.ts` - Redis Cloud connection test specifically for `redis-12901.c328.europe-west3-1.gce.redns.redis-cloud.com:12901`. Verifies TLS connection, basic operations, hash operations, set operations, pipelined operations, and connection persistence. All connections use TLS.
- ✅ `tests/redis-cloud-diagnostic.test.ts` - Diagnostic test to verify Redis Cloud TLS connection methods. Tests TLS socket option and rediss:// URL connections.

### API Route Tests
- ✅ `tests/user-bejis-api.test.ts` - User Bejis API route (`/api/users/[userId]/bejis`) with authentication, error handling, and Redis operations
- ✅ `tests/middleware-auth.test.ts` - Authentication middleware tests for JWT validation, cookie handling, route protection, and redirect logic

**Note:** Redis integration tests require a properly configured `.env.local` file with Redis connection credentials (`REDIS_URL`, `REDIS_HOST`, `REDIS_PORT`, `REDIS_USERNAME`, `REDIS_PASSWORD`, etc.). All connections automatically use TLS. If Redis is not available, these tests will skip gracefully without failing the test suite.

## Redis Client

The project uses `node-redis` (the official Redis client for Node.js) as specified in the [Redis documentation](https://redis.io/docs/latest/develop/clients/nodejs/). All Redis operations use the `node-redis` API:

- Client creation: `createClient({ url })` or `createClient({ socket: { host, port } })`
- **TLS:** All Redis connections automatically use TLS. `redis://` URLs are converted to `rediss://`, and socket connections always have TLS enabled.
- Methods use camelCase: `sAdd`, `sMembers`, `hSet`, `hGetAll`, etc.
- Transactions use `multi()` instead of `pipeline()`
- Connection status: `isReady` or `isOpen` properties instead of `status`
- Cleanup: `await client.quit()` instead of `disconnect()`

